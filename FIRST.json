{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Install VPC, pubsub, prisub",
  
  "Parameters" : {

    "InstanceType" : {
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "t2.micro",
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },
	
	

    "KeyName": {
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
    },
	

    
    "SSHLocation" : {
      "Description" : " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    }
  },
  "Mappings" : {
    "Region2Examples" : {
      "us-east-1"      : { "Examples" : "https://s3.amazonaws.com/cloudformation-examples-us-east-1" },
      "us-west-2"      : { "Examples" : "https://s3-us-west-2.amazonaws.com/cloudformation-examples-us-west-2" },
      "us-west-1"      : { "Examples" : "https://s3-us-west-1.amazonaws.com/cloudformation-examples-us-west-1" },
      "eu-west-1"      : { "Examples" : "https://s3-eu-west-1.amazonaws.com/cloudformation-examples-eu-west-1" },
      "eu-west-2"      : { "Examples" : "https://s3-eu-west-2.amazonaws.com/cloudformation-examples-eu-west-2" }
  
    },

 
    "AWSInstanceType2Arch" : {
      "t1.micro"    : { "Arch" : "PV64"   },
      "t2.nano"     : { "Arch" : "HVM64"  },
      "t2.micro"    : { "Arch" : "HVM64"  }

    },

    "AWSInstanceType2NATArch" : {
      "t1.micro"    : { "Arch" : "NATPV64"   },
      "t2.nano"     : { "Arch" : "NATHVM64"  },
      "t2.micro"    : { "Arch" : "NATHVM64"  }
    
    }
,
    "AWSRegionArch2AMI" : {
      "us-east-1"        : {"PV64" : "ami-2a69aa47", "HVM64" : "ami-97785bed", "HVMG2" : "ami-0a6e3770"},
      "us-west-2"        : {"PV64" : "ami-7f77b31f", "HVM64" : "ami-f2d3638a", "HVMG2" : "ami-ee15a196"},
      "us-west-1"        : {"PV64" : "ami-a2490dc2", "HVM64" : "ami-824c4ee2", "HVMG2" : "ami-0da4a46d"},
      "eu-west-1"        : {"PV64" : "ami-4cdd453f", "HVM64" : "ami-d834aba1", "HVMG2" : "ami-af8013d6"},
      "eu-west-2"        : {"PV64" : "NOT_SUPPORTED", "HVM64" : "ami-403e2524", "HVMG2" : "NOT_SUPPORTED"}
     
    }

  },
  
  
  "Resources" : {

    "myVPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "Tags" : [ {"Key" : "Name", "Value" : "myVPC" } ]
      }
    },

    "publicsubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "myVPC" },
        "CidrBlock" : "10.0.1.0/24",
		"AvailabilityZone" : "us-east-1a",
		"MapPublicIpOnLaunch" : "true",
        "Tags" : [ {"Key" : "Name", "Value" : "PublicSubnet"} ]
      }
    },
	"privatesubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "myVPC" },
        "CidrBlock" : "10.0.2.0/24",
		"AvailabilityZone" : "us-east-1a",
		"MapPublicIpOnLaunch" : "false",
        "Tags" : [ {"Key" : "Name", "Value" : "PrivateSubnet" } ]
      }
    },

	
	

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
	  
        "Tags" : [  {"Key" : "Name", "Value" : "Gate_myVPC" } ]
      }
    },
     "GatewayToInternet" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "myVPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "myVPC"},
        "Tags" : [ {"Key" : "Name", "Value" : "myVPC_pub_route" } ]
      }
    },

    "PublicRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "GatewayToInternet",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },
	
	"PublicSubnetRouteTableAssociate" : {
       "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "SubnetId" : { "Ref" : "publicsubnet" },
            "RouteTableId" : { "Ref" : "PublicRouteTable" }
         }
    },
	
	"NatGateway" : {
		"DependsOn" : "GatewayToInternet",
		"Type" : "AWS::EC2::NatGateway",
		"Properties" : {
			"AllocationId" : { "Fn::GetAtt" : ["EIP", "AllocationId"]},
			"SubnetId" : { "Ref" : "publicsubnet"},
			"Tags" : [ {"Key" : "Name", "Value" : "Nat_myPVC"} ]
		}
	},
	 
	"EIP" : {
		"Type" : "AWS::EC2::EIP",
		"Properties" : {
			"Domain" : "vpc"
			
		}
	},
	
	
	"InstanceSecurityGroup" : {
		"Type" : "AWS::EC2::SecurityGroup",
		"Properties" : {
			"GroupName" : "InstanceSecurityGroup",
			"GroupDescription" : "Allow ssh to client host",
			"VpcId" : {"Ref" : "myVPC"},
			"Tags" : [ {"Key" : "Name", "Value" : "Insta_SecuGroupVPC"} ],
			"SecurityGroupIngress" : [{
				"IpProtocol" : "tcp",
				"FromPort" : "22",
				"ToPort" : "22",
				"CidrIp" : "0.0.0.0/0"
            }]
			
        }
    },
	
	"DBSecurityGroup" : {
		"Type" : "AWS::EC2::SecurityGroup",
		"Properties" : {
			"GroupName" : "DBSecurityGroup",
			"GroupDescription" : "DB connection host",
			"VpcId" : {"Ref" : "myVPC"},
			"Tags" : [ {"Key" : "Name", "Value" : "DB_SecuGroupVPC"} ],
			"SecurityGroupIngress" : [{
				"IpProtocol" : "tcp",
				"FromPort" : "3306",
				"ToPort" : "3306",
				"CidrIp" : "0.0.0.0/0"
            }]
			
        }
    },
	
	
	"PrivateRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "myVPC"},
        "Tags" : [ {"Key" : "Name", "Value" : "myVPC_pri_route"} ]
      }
    },

	
	
	"Route" : {
		"Type" : "AWS::EC2::Route",
		"Properties" : {
		"RouteTableId" : { "Ref" : "PrivateRouteTable" },
		"DestinationCidrBlock" : "0.0.0.0/0",
		"NatGatewayId" : { "Ref" : "NatGateway" }
		}
	},
	
	"PrivateSubnetRouteTableAssociate" : {
       "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "SubnetId" : { "Ref" : "privatesubnet" },
            "RouteTableId" : { "Ref" : "PrivateRouteTable" }
        }
    }
	
}
	
  }
